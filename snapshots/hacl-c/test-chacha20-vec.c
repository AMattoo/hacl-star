#include "kremlib.h"
#include "testlib.h"
#include "Chacha20_vec.h"
#include "sodium.h"
#include "openssl/evp.h"

void ossl_chacha20(uint8_t* cipher, uint8_t* plain, int len, uint8_t* nonce, uint8_t* key){
  EVP_CIPHER_CTX *ctx;
  int clen;
  ctx = EVP_CIPHER_CTX_new();
  EVP_EncryptInit_ex(ctx, EVP_chacha20(), NULL, key, nonce);
  EVP_EncryptUpdate(ctx, cipher, &clen, plain, len);
  EVP_EncryptFinal_ex(ctx, cipher + clen, &clen);
  EVP_CIPHER_CTX_free(ctx);
}


void print_results(char *txt, double t1, unsigned long long d1, int rounds, int plainlen){
  printf("Testing: %s\n", txt);
  printf("Cycles for %d * %d bytes: %llu (%.2fcycles/byte)\n", rounds, plainlen, d1, (double)d1/plainlen/rounds);
  double ts = t1/CLOCKS_PER_SEC;
  printf("User time for %d times %d bytes: %fs (%fus/byte)\n", rounds, plainlen, ts, (double)(ts*1000000)/(plainlen*rounds));
}

#define PLAINLEN (512*1024)
#define ROUNDS 1000
#define MACSIZE 32

uint8_t
plaintext[754] =
    {
      (uint8_t )0x4c,
      (uint8_t )0x61,
      (uint8_t )0x64,
      (uint8_t )0x69,
      (uint8_t )0x65,
      (uint8_t )0x73,
      (uint8_t )0x20,
      (uint8_t )0x61,
      (uint8_t )0x6e,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x47,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x74,
      (uint8_t )0x6c,
      (uint8_t )0x65,
      (uint8_t )0x6d,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x6f,
      (uint8_t )0x66,
      (uint8_t )0x20,
      (uint8_t )0x74,
      (uint8_t )0x68,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x63,
      (uint8_t )0x6c,
      (uint8_t )0x61,
      (uint8_t )0x73,
      (uint8_t )0x73,
      (uint8_t )0x20,
      (uint8_t )0x6f,
      (uint8_t )0x66,
      (uint8_t )0x20,
      (uint8_t )0x27,
      (uint8_t )0x39,
      (uint8_t )0x39,
      (uint8_t )0x3a,
      (uint8_t )0x20,
      (uint8_t )0x49,
      (uint8_t )0x66,
      (uint8_t )0x20,
      (uint8_t )0x49,
      (uint8_t )0x20,
      (uint8_t )0x63,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x6f,
      (uint8_t )0x66,
      (uint8_t )0x66,
      (uint8_t )0x65,
      (uint8_t )0x72,
      (uint8_t )0x20,
      (uint8_t )0x79,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x20,
      (uint8_t )0x6f,
      (uint8_t )0x6e,
      (uint8_t )0x6c,
      (uint8_t )0x79,
      (uint8_t )0x20,
      (uint8_t )0x6f,
      (uint8_t )0x6e,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x74,
      (uint8_t )0x69,
      (uint8_t )0x70,
      (uint8_t )0x20,
      (uint8_t )0x66,
      (uint8_t )0x6f,
      (uint8_t )0x72,
      (uint8_t )0x20,
      (uint8_t )0x74,
      (uint8_t )0x68,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x66,
      (uint8_t )0x75,
      (uint8_t )0x74,
      (uint8_t )0x75,
      (uint8_t )0x72,
      (uint8_t )0x65,
      (uint8_t )0x2c,
      (uint8_t )0x20,
      (uint8_t )0x73,
      (uint8_t )0x75,
      (uint8_t )0x6e,
      (uint8_t )0x73,
      (uint8_t )0x63,
      (uint8_t )0x72,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,

      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,

      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,


      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e,
      (uint8_t )0x65,
      (uint8_t )0x65,
      (uint8_t )0x6e,
      (uint8_t )0x20,
      (uint8_t )0x77,
      (uint8_t )0x6f,
      (uint8_t )0x75,
      (uint8_t )0x6c,
      (uint8_t )0x64,
      (uint8_t )0x20,
      (uint8_t )0x62,
      (uint8_t )0x65,
      (uint8_t )0x20,
      (uint8_t )0x69,
      (uint8_t )0x74,
      (uint8_t )0x2e
    };
uint8_t
expected[754] =
    {
	 0x6e,
	 0x2e,
	 0x35,
	 0x9a,
	 0x25,
	 0x68,
	 0xf9,
	 0x80,
	 0x41,
	 0xba,
	 0x07,
	 0x28,
	 0xdd,
	 0x0d,
	 0x69,
	 0x81,
	 0xe9,
	 0x7e,
	 0x7a,
	 0xec,
	 0x1d,
	 0x43,
	 0x60,
	 0xc2,
	 0x0a,
	 0x27,
	 0xaf,
	 0xcc,
	 0xfd,
	 0x9f,
	 0xae,
	 0x0b,
	 0xf9,
	 0x1b,
	 0x65,
	 0xc5,
	 0x52,
	 0x47,
	 0x33,
	 0xab,
	 0x8f,
	 0x59,
	 0x3d,
	 0xab,
	 0xcd,
	 0x62,
	 0xb3,
	 0x57,
	 0x16,
	 0x39,
	 0xd6,
	 0x24,
	 0xe6,
	 0x51,
	 0x52,
	 0xab,
	 0x8f,
	 0x53,
	 0x0c,
	 0x35,
	 0x9f,
	 0x08,
	 0x61,
	 0xd8,
	 0x07,
	 0xca,
	 0x0d,
	 0xbf,
	 0x50,
	 0x0d,
	 0x6a,
	 0x61,
	 0x56,
	 0xa3,
	 0x8e,
	 0x08,
	 0x8a,
	 0x22,
	 0xb6,
	 0x5e,
	 0x52,
	 0xbc,
	 0x51,
	 0x4d,
	 0x16,
	 0xcc,
	 0xf8,
	 0x06,
	 0x81,
	 0x8c,
	 0xe9,
	 0x1a,
	 0xb7,
	 0x79,
	 0x37,
	 0x36,
	 0x5a,
	 0xf9,
	 0x0b,
	 0xbf,
	 0x74,
	 0xa3,
	 0x5b,
	 0xe6,
	 0xb4,
	 0x0b,
	 0x8e,
	 0xed,
	 0xf2,
	 0x78,
	 0x5e,
	 0x42,
	 0x87,
	 0x4d,
	 0x11,
	 0x66,
	 0x1d,
	 0x00,
	 0x6d,
	 0xce,
	 0xfd,
	 0x97,
	 0xd8,
	 0xc8,
	 0x5b,
	 0xf4,
	 0xe4,
	 0x84,
	 0xbc,
	 0xc3,
	 0x63,
	 0x29,
	 0x00,
	 0xb3,
	 0xea,
	 0x2f,
	 0x44,
	 0x19,
	 0x8a,
	 0xc1,
	 0x25,
	 0x35,
	 0xd3,
	 0x8c,
	 0xdd,
	 0x80,
	 0xee,
	 0x23,
	 0xaf,
	 0x6d,
	 0xda,
	 0x25,
	 0xe3,
	 0x44,
	 0xae,
	 0x8f,
	 0x64,
	 0x2f,
	 0x01,
	 0xb9,
	 0x7e,
	 0x5c,
	 0x36,
	 0xc8,
	 0x96,
	 0xef,
	 0xf9,
	 0xdf,
	 0xed,
	 0x00,
	 0x5a,
	 0x48,
	 0x10,
	 0xa3,
	 0xfe,
	 0x0c,
	 0x39,
	 0xae,
	 0x13,
	 0xae,
	 0xf4,
	 0x81,
	 0xeb,
	 0x78,
	 0x34,
	 0x51,
	 0xe2,
	 0x9c,
	 0x6c,
	 0xb0,
	 0x4b,
	 0x7a,
	 0xda,
	 0xfd,
	 0x90,
	 0x82,
	 0x94,
	 0xad,
	 0x7e,
	 0x33,
	 0x45,
	 0x09,
	 0x23,
	 0x08,
	 0x57,
	 0x01,
	 0xec,
	 0xfa,
	 0x15,
	 0xd1,
	 0x46,
	 0x20,
	 0x43,
	 0x97,
	 0xb1,
	 0x19,
	 0x10,
	 0x19,
	 0xe1,
	 0x80,
	 0x87,
	 0x14,
	 0x5b,
	 0x68,
	 0xbd,
	 0xa3,
	 0x58,
	 0x2b,
	 0xed,
	 0xe7,
	 0xd1,
	 0xb4,
	 0xd9,
	 0x99,
	 0x40,
	 0xc0,
	 0xa6,
	 0xf7,
	 0x61,
	 0xc6,
	 0xf3,
	 0x25,
	 0x76,
	 0x16,
	 0x7b,
	 0x85,
	 0x52,
	 0x16,
	 0x95,
	 0xbd,
	 0x21,
	 0x5d,
	 0x1b,
	 0xc4,
	 0xed,
	 0x4f,
	 0xbf,
	 0x7f,
	 0xd0,
	 0xc7,
	 0x73,
	 0x9d,
	 0x4f,
	 0x67,
	 0x99,
	 0x1b,
	 0x35,
	 0xcb,
	 0xfb,
	 0x55,
	 0xf3,
	 0x31,
	 0x2b,
	 0xef,
	 0x5f,
	 0xa2,
	 0xd9,
	 0x60,
	 0xc4,
	 0x62,
	 0x7d,
	 0x6a,
	 0x3e,
	 0x2c,
	 0xb0,
	 0x24,
	 0x01,
	 0xc4,
	 0x45,
	 0x51,
	 0xd2,
	 0x27,
	 0xce,
	 0xc1,
	 0x2e,
	 0x12,
	 0xe8,
	 0xa5,
	 0x71,
	 0x4f,
	 0x62,
	 0x8d,
	 0x75,
	 0xcc,
	 0xbd,
	 0xfa,
	 0xbd,
	 0xd9,
	 0xad,
	 0x94,
	 0x57,
	 0x58,
	 0x57,
	 0x47,
	 0xdf,
	 0x8c,
	 0xaf,
	 0xf7,
	 0x59,
	 0x54,
	 0xfd,
	 0xd3,
	 0xb2,
	 0x55,
	 0x05,
	 0xa8,
	 0xb7,
	 0x02,
	 0x0e,
	 0x87,
	 0x70,
	 0x24,
	 0x62,
	 0xf9,
	 0x70,
	 0xd2,
	 0x13,
	 0xca,
	 0x5c,
	 0xe9,
	 0x5a,
	 0xb4,
	 0x05,
	 0x43,
	 0x92,
	 0x02,
	 0x14,
	 0xef,
	 0xfa,
	 0x4e,
	 0x25,
	 0x0a,
	 0x4e,
	 0x32,
	 0x73,
	 0xef,
	 0x88,
	 0x75,
	 0x55,
	 0x4c,
	 0xdc,
	 0xc9,
	 0x83,
	 0x99,
	 0x72,
	 0x73,
	 0xbf,
	 0xba,
	 0x6f,
	 0x4e,
	 0x3d,
	 0x7d,
	 0x2d,
	 0xc5,
	 0x9d,
	 0xe0,
	 0xcc,
	 0xca,
	 0x5b,
	 0x1f,
	 0x0e,
	 0x48,
	 0x34,
	 0x76,
	 0x6e,
	 0xb5,
	 0xc7,
	 0xb1,
	 0xd5,
	 0x4e,
	 0x03,
	 0xe1,
	 0x09,
	 0x4c,
	 0xea,
	 0x6d,
	 0x0a,
	 0x44,
	 0x02,
	 0xfd,
	 0xfa,
	 0x11,
	 0x08,
	 0x30,
	 0x56,
	 0x88,
	 0x90,
	 0xaa,
	 0x38,
	 0xbb,
	 0x7f,
	 0x60,
	 0x2c,
	 0x90,
	 0x67,
	 0x89,
	 0xc3,
	 0xf5,
	 0x80,
	 0xc1,
	 0x79,
	 0x29,
	 0x61,
	 0xe7,
	 0x6d,
	 0xc5,
	 0x29,
	 0x26,
	 0x7a,
	 0x17,
	 0xa0,
	 0x54,
	 0x7a,
	 0x24,
	 0xe5,
	 0x57,
	 0xa9,
	 0x30,
	 0xaa,
	 0xa9,
	 0x44,
	 0x96,
	 0xf1,
	 0x69,
	 0xbd,
	 0xc8,
	 0x61,
	 0x5f,
	 0xcc,
	 0xa2,
	 0xff,
	 0xf1,
	 0x4f,
	 0xc3,
	 0xd0,
	 0xd3,
	 0x94,
	 0x07,
	 0x1b,
	 0xac,
	 0x19,
	 0x6f,
	 0x0d,
	 0x15,
	 0x55,
	 0x54,
	 0x7c,
	 0xe7,
	 0x19,
	 0xf2,
	 0x69,
	 0xf1,
	 0x81,
	 0xfa,
	 0x06,
	 0xe4,
	 0x72,
	 0x1f,
	 0xff,
	 0xb1,
	 0x67,
	 0xac,
	 0xb2,
	 0xd6,
	 0x70,
	 0xbf,
	 0x00,
	 0x3c,
	 0x1d,
	 0x9c,
	 0x5f,
	 0x36,
	 0xcc,
	 0x5f,
	 0xbd,
	 0xea,
	 0x31,
	 0xd3,
	 0xdd,
	 0x36,
	 0xf8,
	 0x92,
	 0xcb,
	 0xbe,
	 0xc3,
	 0x60,
	 0x60,
	 0xfe,
	 0x48,
	 0x46,
	 0x56,
	 0xc9,
	 0x95,
	 0x10,
	 0x59,
	 0xfa,
	 0x88,
	 0x2b,
	 0xc6,
	 0x7e,
	 0x3f,
	 0x67,
	 0x79,
	 0x47,
	 0x2a,
	 0x75,
	 0x7f,
	 0x6e,
	 0x84,
	 0x84,
	 0x2a,
	 0x80,
	 0x19,
	 0x81,
	 0x99,
	 0x90,
	 0x07,
	 0xb7,
	 0x29,
	 0x44,
	 0xd4,
	 0xf3,
	 0xff,
	 0x01,
	 0xc8,
	 0xbc,
	 0x93,
	 0xe7,
	 0x26,
	 0xd7,
	 0xc3,
	 0x5e,
	 0x48,
	 0x0c,
	 0xda,
	 0x95,
	 0x08,
	 0x54,
	 0xd6,
	 0x99,
	 0xf3,
	 0x88,
	 0xd7,
	 0x96,
	 0x0c,
	 0xab,
	 0x45,
	 0xd1,
	 0x2f,
	 0xff,
	 0xc0,
	 0x3f,
	 0x69,
	 0x94,
	 0x25,
	 0x90,
	 0xf7,
	 0xbc,
	 0xc1,
	 0xbf,
	 0x39,
	 0xf6,
	 0x17,
	 0xfb,
	 0x44,
	 0x28,
	 0x08,
	 0x3b,
	 0xfa,
	 0x38,
	 0x10,
	 0xa0,
	 0x55,
	 0xfa,
	 0xa9,
	 0xff,
	 0x7b,
	 0x83,
	 0x57,
	 0xc8,
	 0x33,
	 0xca,
	 0x7a,
	 0x0a,
	 0xa7,
	 0x0a,
	 0xed,
	 0x18,
	 0xf4,
	 0x59,
	 0xc1,
	 0x73,
	 0x13,
	 0x12,
	 0x38,
	 0x7b,
	 0x5e,
	 0x48,
	 0x43,
	 0xe2,
	 0x8d,
	 0x6e,
	 0xfe,
	 0x98,
	 0x1a,
	 0xb8,
	 0xe8,
	 0x70,
	 0xbe,
	 0xd1,
	 0x7f,
	 0x4b,
	 0xa7,
	 0x37,
	 0xc9,
	 0x76,
	 0xb8,
	 0x39,
	 0xb0,
	 0xbd,
	 0xce,
	 0x52,
	 0x3b,
	 0xbb,
	 0x97,
	 0xa1,
	 0xd5,
	 0x05,
	 0x58,
	 0xb0,
	 0x65,
	 0x33,
	 0xe0,
	 0x10,
	 0x2b,
	 0x64,
	 0x92,
	 0x03,
	 0xf2,
	 0x29,
	 0x75,
	 0xc7,
	 0x2f,
	 0x27,
	 0x2c,
	 0xe2,
	 0x78,
	 0x8d,
	 0x26,
	 0xa2,
	 0x6e,
	 0xa3,
	 0x8e,
	 0xe2,
	 0xa1,
	 0xbe,
	 0xcc,
	 0xac,
	 0x28,
	 0xbe,
	 0xd1,
	 0x14,
	 0x4a,
	 0x6f,
	 0x73,
	 0x50,
	 0x5b,
	 0xb8,
	 0x2f,
	 0x4f,
	 0xd0,
	 0xdd,
	 0x70,
	 0xe5,
	 0xa3,
	 0x88,
	 0x9a,
	 0xda,
	 0xff,
	 0xee,
	 0xdf,
	 0x94,
	 0xee,
	 0xa5,
	 0xc3,
	 0x83,
	 0x4a,
	 0xfc,
	 0x01,
	 0x0b,
	 0x44,
	 0x7b,
	 0xa9,
	 0x3b,
	 0xe9,
	 0xa3,
	 0x5a,
	 0xe3,
	 0x98,
	 0xea,
	 0x34,
	 0xcc,
	 0xc4,
	 0xa4,
	 0xe9,
	 0xc6,
	 0xea,
	 0xb1,
	 0xdf,
	 0xa2,
	 0x60,
	 0x8c,
	 0x17,
	 0x59,
	 0x47,
	 0x45,
	 0x32,
	 0x05,
	 0x41,
	 0xf4,
	 0x8b,
	 0x34,
	 0x86,
	 0xad,
	 0x9b,
	 0x3d,
	 0xb2,
	 0x57,
	 0xe2,
	 0xbe,
	 0x55,
	 0xbf,
	 0xe5,
	 0x82
    };
uint8_t
key[32] =
    {
      (uint8_t )0,
      (uint8_t )1,
      (uint8_t )2,
      (uint8_t )3,
      (uint8_t )4,
      (uint8_t )5,
      (uint8_t )6,
      (uint8_t )7,
      (uint8_t )8,
      (uint8_t )9,
      (uint8_t )10,
      (uint8_t )11,
      (uint8_t )12,
      (uint8_t )13,
      (uint8_t )14,
      (uint8_t )15,
      (uint8_t )16,
      (uint8_t )17,
      (uint8_t )18,
      (uint8_t )19,
      (uint8_t )20,
      (uint8_t )21,
      (uint8_t )22,
      (uint8_t )23,
      (uint8_t )24,
      (uint8_t )25,
      (uint8_t )26,
      (uint8_t )27,
      (uint8_t )28,
      (uint8_t )29,
      (uint8_t )30,
      (uint8_t )31
    };
uint8_t
nonce[12] =
    {
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0x4a,
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0,
      (uint8_t )0
    };

int32_t test_chacha()
{
  uint32_t len = (uint32_t )754;
  uint8_t ciphertext[len];
  memset(ciphertext, 0, len * sizeof ciphertext[0]); 
  uint32_t counter = (uint32_t )1;
  Chacha20_vec_crypto_stream_xor_ic(ciphertext, plaintext, len, nonce, key,1);
  TestLib_compare_and_print("HACL Chacha20", expected, ciphertext, len);
  crypto_stream_chacha20_ietf_xor_ic(ciphertext,plaintext, len, nonce, 1, key);
  TestLib_compare_and_print("Sodium Chacha20", expected, ciphertext, len);

  return exit_success;
}

int32_t perf_chacha() {
  uint32_t len = PLAINLEN * sizeof(char);
  uint8_t* plain = malloc(len);
  uint8_t* cipher = malloc(len);
  int fd = open("/dev/urandom", O_RDONLY);
  uint64_t res = read(fd, plain, len);
  if (res != len) {
    printf("Error on reading, got %llu bytes\n", res);
    return 1;
  }

  uint32_t counter = (uint32_t )1;
  uint32_t ctx[32] = { 0 };

  cycles a,b;
  clock_t t1,t2;

  t1 = clock();
  a = TestLib_cpucycles_begin();
  for (int i = 0; i < ROUNDS; i++){
    Chacha20_vec_crypto_stream_xor_ic(plain, plain, len, nonce, key,1);
  }
  b = TestLib_cpucycles_end();
  t2 = clock();
  print_results("HACL VEC ChaCha20 speed", (double)t2-t1,
		(double) b - a, ROUNDS, PLAINLEN);
  for (int i = 0; i < PLAINLEN; i++) 
    res += (uint64_t) plain[i];
  printf("Composite result (ignore): %llx\n", res);
  t1 = clock();
  a = TestLib_cpucycles_begin();
  for (int i = 0; i < ROUNDS; i++){
    crypto_stream_chacha20_ietf_xor(plain,plain, len, nonce, key);
  }
  b = TestLib_cpucycles_end();
  t2 = clock();
  print_results("Sodium ChaCha20 speed", (double)t2-t1,
		(double) b - a, ROUNDS, PLAINLEN);
  for (int i = 0; i < PLAINLEN; i++) 
    res += (uint64_t) plain[i];
  printf("Composite result (ignore): %llx\n", res);

  t1 = clock();
  a = TestLib_cpucycles_begin();
  for (int i = 0; i < ROUNDS; i++){
    ossl_chacha20(plain,plain, len, nonce, key);
  }
  b = TestLib_cpucycles_end();
  t2 = clock();
  print_results("OpenSSL ChaCha20 speed", (double)t2-t1,
		(double) b - a, ROUNDS, PLAINLEN);
  for (int i = 0; i < PLAINLEN; i++) 
    res += (uint64_t) plain[i];
  printf("Composite result (ignore): %llx\n", res);

  return exit_success;
}

int32_t main()
{
  test_chacha();
  //if (res == exit_success) {
    perf_chacha();
    //}
  return 0;
}
  
